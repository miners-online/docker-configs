services:
  proxy:
    image: itzg/mc-proxy:latest
    ports:
      - "0.0.0.0:25565:25565"
      - "0.0.0.0:25565:25565/udp"
      - "0.0.0.0:19132:19132"
      - "0.0.0.0:19132:19132/udp"
    env_file:
      - ./.env
    environment:
      TYPE: "VELOCITY"
      VELOCITY_VERSION: "latest"
      MEMORY: "512M"
      USE_AIKAR_FLAGS: true
      ICON: "https://github.com/miners-online/.github/blob/main/profile/logos/favicon-64x64.png?raw=true"
      PLUGINS_FILE: /extras/plugins.txt
      # Configs
      REPLACE_ENV_VARIABLES: "TRUE"
      ENV_VARIABLE_PREFIX: "CFG_"
      CFG_FORWARDING_SECRET: ${FORWARDING_SECRET}
    volumes:
      - ./data/proxy:/config
      - ./data/proxy/plugins.txt:/extras/plugins.txt
      - ./data/proxy/forwarding.secret.yml:/config/forwarding.secret.yml
      - ./data/proxy/velocity.toml:/server/velocity.toml:rw
    deploy:
      replicas: 1
      restart_policy:
        condition: any

  lobby:
    image: itzg/minecraft-server:latest
    env_file:
      - ./.env
    environment:
      EULA: "TRUE"
      TYPE: "CUSTOM"
      CUSTOM_SERVER: "http://10.0.0.12:82/server_setup/lobby-1/server.jar"
      VERSION: "1.21.1"
      MEMORY: "1024M"
      DIFFICULTY: peaceful
      USE_AIKAR_FLAGS: true
      ONLINE_MODE: false
      WORLD: http://10.0.0.12:82/server_setup/lobby-1/world.zip
      REMOVE_OLD_MODS: true
      # Configs
      REPLACE_ENV_VARIABLES: "TRUE"
      ENV_VARIABLE_PREFIX: "CFG_"
      CFG_FORWARDING_SECRET: ${FORWARDING_SECRET}
    volumes:
      - ./data/lobby-1:/config
    deploy:
      replicas: 2
      restart_policy:
        condition: any